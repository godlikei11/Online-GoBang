<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <style>
        html, body{
            padding: 0;
            margin: 0;
        } 
        canvas {
            background-color:#d1a443;
            position: fixed;
        }
        .notclick{
            pointer-events: none;
        }
        .click{
            pointer-events: auto;
        }
        #user1{
            font-size: 100px;
            font-family:Verdana, Geneva, Tahoma, sans-serif;
            position:relative;
            z-index:99999;
        }
        #user2{
            font-size: 100px;
            font-family:Verdana, Geneva, Tahoma, sans-serif;
            position:relative;
            z-index:99999;

        }
        #user2Background{
            width: 100%;
            position: absolute;
        }
        #user1Background{
            width: 100%;
            position: absolute;
        }
        #button{
            width: 100px;
            height: 50px;
        }
    </style>
</head>
<body>

    <div id="user1Background"><div id="user1"></div></div>
    <div id="user2Background"><div id="user2"></div></div>

    <canvas id="canvas" class="notclick"></canvas>                
    <button id="button">Withdraw</button>
    <div id="mocha"></div>

    <script>
        
let chessGame = (function(){

    let canvas = document.getElementById("canvas");
    let button = document.getElementById("button");
    let user1 = document.getElementById("user1");
    let user2 = document.getElementById("user2");
    let user2Background = document.getElementById("user2Background");
    let user1Background = document.getElementById("user1Background");
    let ctx = canvas.getContext("2d");
    let list = [];
    let chessWidth = 30;
    let size = 15;
    canvas.width = chessWidth * (size+1);
    canvas.height = canvas.width;
    button.style.marginLeft = (chessWidth * (size-2))/2+"px";
    button.style.marginTop = chessWidth * (size+2)+"px";
    user1.style.marginLeft = chessWidth * (size+2)+"px";
    user2.style.marginLeft = chessWidth * (size+2)+"px";
    user2Background.style.height = (chessWidth * (size+1))/2+"px";
    user1Background.style.height = (chessWidth * (size+1))/2+"px";
    user1Background.style.marginTop = (chessWidth * (size+1))/2+"px";
    function drawChessboard(){
        for(let i=1;i<size+1;i++){
            ctx.beginPath();
            ctx.moveTo(chessWidth,i*chessWidth);
            ctx.lineTo(chessWidth*size,i*chessWidth);
            ctx.stroke();
    
            ctx.beginPath();
            ctx.moveTo(i*chessWidth,chessWidth);
            ctx.lineTo(i*chessWidth,chessWidth*size);
            ctx.stroke();
    
        }
    }
    
    function drawChess(item){
        ctx.beginPath();
        ctx.arc(item.x,item.y,chessWidth/2,0,2*Math.PI,false);
        ctx.fillStyle = item.color;
        ctx.fill();
        return item;
    }
    
    function clearCanvas(){
        ctx.clearRect(chessWidth/2,chessWidth/2,size*chessWidth,size*chessWidth);
    }
    
    function setList(data){
        list = data;
    }
    
    function getList() {
        return list;
    }

    function isChessThere(chessInfo) {
        return list.filter(function(item) {
            return item.x === chessInfo.x && item.y === chessInfo.y;
        }).length > 0;
    }
    
    function checkWin(chessInfo) {
        let winCase = [];
        for(let k=0;k<4;k++){
            winCase[k] = winCase[k]||[];
            for(let j=0;j<5;j++){
                winCase[k][j] = winCase[k][j]||[];
                for(let i=-j;i<5-j;i++){
                    if(k === 0){
                        winCase[k][j].push({
                            x:chessInfo.x - i*chessWidth,
                            y:chessInfo.y,
                            color:chessInfo.color
                        })
                    }
                    if(k === 1){
                        winCase[k][j].push({
                            x:chessInfo.x,
                            y:chessInfo.y - i*chessWidth,
                            color:chessInfo.color
                        })
                    }
                    if(k === 2){
                        winCase[k][j].push({
                            x:chessInfo.x - i*chessWidth,
                            y:chessInfo.y - i*chessWidth,
                            color:chessInfo.color
                        })
                    }
                    if(k === 3){
                        winCase[k][j].push({
                            x:chessInfo.x + i*chessWidth,
                            y:chessInfo.y - i*chessWidth,
                            color:chessInfo.color
                        })
                    }
                }
            }
        }
        return winCase.some(function(winPosition){
            return winPosition.some(function(winList){
                return winList.every(function(item){
                    return list.filter(function(chess){
                        return item.x === chess.x && item.y === chess.y && item.color === chess.color
                    }).length>0
                })
            })
        })

    }

    function play(e){
        if(e.clientY<=chessWidth/2||
            e.clientY>=chessWidth*size + chessWidth / 2||
            e.clientX>=chessWidth*size + chessWidth / 2||
            e.clientX<=chessWidth/2){
            return
        }
        let chessInfo = {
            x:Math.round(e.clientX/chessWidth)*chessWidth,
            y:Math.round(e.clientY/chessWidth)*chessWidth,
            color:list.length % 2 === 0 ? 'black' : "white"
        }
        if(isChessThere(chessInfo)){
            return
        }
        list.push(chessInfo)
        console.log(list);
        window.dispatchEvent(new CustomEvent("updateChess",{detail:list}));
        drawChess(list[list.length-1]);
        checkWin(chessInfo);
    }

    function withdraw(){
        list.pop();
        window.dispatchEvent(new CustomEvent("updateChess",{detail:list}));
        clearCanvas();
        drawChessboard();
        list.forEach(drawChess);
    }

    
    function bindEvent() {
        canvas.addEventListener("click",play)
        button.addEventListener("click",withdraw)
    }

    drawChessboard();
    bindEvent();

    return{
        list:list,
        checkWin : checkWin,
        withdraw: withdraw,
        clearCanvas : clearCanvas,
        drawChessboard : drawChessboard,
        drawChess : drawChess,
        setList : setList,
        getList : getList,   
        isChessThere:isChessThere,
    }
})()


    </script> 
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>

    <script class="mocha-init">
        mocha.setup('tdd');
        mocha.checkLeaks();
    </script>
        <script src="./app.test.js"></script>
        <script class="mocha-exec">
            mocha.run();
        </script>

</body>
</html>